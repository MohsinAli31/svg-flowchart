<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowchart</title>
    <style>
        svg {
            border: 1px solid #ccc;
        }

        .node {
            fill: #ffffff;
            stroke: #000000;
            stroke-width: 2;
            cursor: pointer;
        }

        .arrow {
            fill: none;
            stroke: #000000;
            stroke-width: 2;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <svg id="flowchart" width="600" height="400">
        <!-- Arrowhead marker definition -->
        <defs>
            <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6"
                orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" />
            </marker>
        </defs>
    </svg>

    <div>
        <img src="image1.png" alt="Image 1" onclick="createNode('Node 1')">
        <img src="image2.png" alt="Image 2" onclick="createNode('Node 2')">
    </div>

    <button onclick="connectNodes()">Connect Nodes</button>

    <script>
        const svg = document.getElementById('flowchart');
        let nodes = [];
        function createNode(text) {
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.setAttribute('transform', `translate(${Math.random() * 400}, ${Math.random() * 300})`);
            group.setAttribute('class', 'node'); // Add class 'node'

            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('class', 'node');
            rect.setAttribute('x', '0');
            rect.setAttribute('y', '0');
            rect.setAttribute('width', '100');
            rect.setAttribute('height', '50');

            const textNode = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textNode.setAttribute('x', '50');
            textNode.setAttribute('y', '35');
            textNode.setAttribute('text-anchor', 'middle');
            textNode.textContent = text;

            group.appendChild(rect);
            group.appendChild(textNode);
            group.addEventListener('click', function (event) {
                console.log("clicked")
                if (!nodes.includes(group)) {
                    console.log("clicked inside")
                    // group.setAttribute('stroke', 'blue');
                    group.style.stroke = 'blue'
                    nodes.push(group);
                }
                else {
                    // group.setAttribute('stroke', 'black');
                    group.style.stroke = 'black'
                    const index = nodes.indexOf(group);
                    nodes.splice(index, 1);
                }
            });

            // Add drag functionality to the node group
            group.addEventListener('mousedown', startDrag);

            svg.appendChild(group);
        }

        // Drag functions
        let selectedNode = null;
        let offset = { x: 0, y: 0 };

        function startDrag(event) {
            selectedNode = event.currentTarget;
            offset.x = selectedNode.getBoundingClientRect().left - event.clientX;
            offset.y = selectedNode.getBoundingClientRect().top - event.clientY;

            window.addEventListener('mousemove', dragNode);
            window.addEventListener('mouseup', endDrag);
        }

        function dragNode(event) {
            if (selectedNode) {
                const x = event.clientX + offset.x;
                const y = event.clientY + offset.y;
                selectedNode.setAttribute('transform', `translate(${x}, ${y})`);
            }
        }

        function endDrag(event) {
            selectedNode = null;
            window.removeEventListener('mousemove', dragNode);
            window.removeEventListener('mouseup', endDrag);
        }



        function connectNodes() {
            if (nodes.length !== 2) {
                alert('Please select exactly two nodes to connect.');
                return;
            }

            const [node1, node2] = nodes;
            const rect1 = node1.querySelector('rect');
            const rect2 = node2.querySelector('rect');
            const x1 = parseInt(node1.getAttribute('transform').split(',')[0].slice(10));
            const y1 = parseInt(node1.getAttribute('transform').split(',')[1].slice(0, -1));
            const x2 = parseInt(node2.getAttribute('transform').split(',')[0].slice(10));
            const y2 = parseInt(node2.getAttribute('transform').split(',')[1].slice(0, -1));
            const rectWidth = parseInt(rect1.getAttribute('width'));
            const rectHeight = parseInt(rect1.getAttribute('height'));

            const x1Center = x1 + rectWidth / 2;
            const y1Center = y1 + rectHeight / 2;
            const x2Center = x2 + rectWidth / 2;
            const y2Center = y2 + rectHeight / 2;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'arrow');

            // Create an L-shaped path
            const d = `M ${x1Center} ${y1Center} L ${x1Center} ${y2Center} L ${x2Center} ${y2Center}`;
            path.setAttribute('d', d);

            // Add arrowhead marker
            path.setAttribute('marker-end', 'url(#arrow)');

            path.addEventListener('click', function (event) {
                svg.removeChild(path);
                const index1 = nodes.indexOf(node1);
                const index2 = nodes.indexOf(node2);
                nodes.splice(index1, 1);
                nodes.splice(index2 - 1, 1);
            });

            svg.appendChild(path);
            nodes.forEach(node => node.setAttribute('stroke', 'black'));
            nodes = [];
        }
        

        function getMousePosition(event) {
            const CTM = svg.getScreenCTM();
            return {
                x: (event.clientX - CTM.e) / CTM.a,
                y: (event.clientY - CTM.f) / CTM.d
            };
        }

    </script>

</body>

</html>